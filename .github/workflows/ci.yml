name: CI

on:
  push:
    branches: [ main, develop ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'

env:
  NODE_VERSION: '20'
  DATABASE_PATH: './data/test.db'

jobs:
  # ========== 代码质量检查 ==========
  lint-and-type-check:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run ESLint
      run: npm run lint --if-present || echo "No lint script"
    
    - name: Run TypeScript check
      run: npm run type-check --if-present || echo "No type-check script"

  # ========== 单元测试 ==========
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: lint-and-type-check
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run unit tests
      run: npm run test:unit --if-present -- --passWithNoTests || echo "No unit tests yet"

  # ========== 构建验证 ==========
  build:
    name: Build Verification
    runs-on: ubuntu-latest
    needs: lint-and-type-check
    
    strategy:
      matrix:
        app: [bridge, web]
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Build ${{ matrix.app }}
      run: |
        cd apps/${{ matrix.app }}
        if [ -f "package.json" ]; then
          npm run build --if-present || echo "No build script"
        fi

  # ========== 技能验证 ==========
  skill-validation:
    name: Skill Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
    
    - name: Validate skill structure
      run: |
        if [ -f "scripts/validate-skills.js" ]; then
          node scripts/validate-skills.js
        else
          echo "Skill validator not found, checking manually..."
          for skill in skills/*/; do
            if [ -f "$skill/SKILL.md" ]; then
              echo "✅ $(basename $skill) has SKILL.md"
            else
              echo "❌ $(basename $skill) missing SKILL.md"
              exit 1
            fi
          done
        fi
    
    - name: Check Superpowers skills
      run: |
        if [ -d "skills/superpowers" ]; then
          echo "✅ Superpowers skills found"
          ls -la skills/superpowers/skills/ | head -20
        else
          echo "⚠️ Superpowers skills not found"
        fi
    
    - name: Check Moltbook skills
      run: |
        if [ -d "skills/moltbook-talent-marketplace" ]; then
          echo "✅ Moltbook marketplace skill found"
        else
          echo "⚠️ Moltbook marketplace skill not found"
        fi

  # ========== 测试总结 ==========
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, build, skill-validation]
    if: always()
    
    steps:
    - name: Check all jobs status
      run: |
        echo "Unit Tests: ${{ needs.unit-tests.result }}"
        echo "Build: ${{ needs.build.result }}"
        echo "Skill Validation: ${{ needs.skill-validation.result }}"
        
        if [ "${{ needs.unit-tests.result }}" = "failure" ] || \
           [ "${{ needs.build.result }}" = "failure" ] || \
           [ "${{ needs.skill-validation.result }}" = "failure" ]; then
          echo "❌ P0 tests failed"
          exit 1
        fi
        
        echo "✅ All P0 tests passed"
